<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: controllers/emailSubmit.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: controllers/emailSubmit.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { Carrito } from '../entities/Carrito.js';
import { MealsRepository } from '../repository/MealsRepository.js';
import { ListDeMensajesDispoiblesEnum, ListaDeTiposDeAlertaEnum, modalConMensaje } from '../utils/modalConMensaje.js';

/**
 * 
 * @param {Event} e 
 */
export async function handleEmailSubmit(e) {
    e.preventDefault();

    const emailInserted = e.target.children.email.value;
    const userName = JSON.parse(sessionStorage.getItem('currentUser')).username;
    const carrito = new Carrito().getCarrito();
    let carritoUsuarioParseado = '';

    for (const [key, value] of carrito) {
        const data = await new MealsRepository().getMealById(key);
        const { strMeal } = data;

        carritoUsuarioParseado += `+ ${strMeal}: ${value} unidades \n`;
    }


    const precio = await new Carrito().getPrecioTotalCarrito();

    const precioTexto = `${precio} $`;
    const precioTextoConIva = `${(Number(precio) * 1.21).toFixed(2)} $`;;

    const necesaryDataForEmail = { emailInserted, userName, carritoUsuarioParseado, precioTexto, precioTextoConIva };

    sendEmail(necesaryDataForEmail);

    const spinner = document.querySelector('.spinner');
    spinner.style.display = 'block';
    spinner.style.top = '30%';

    e.target.reset();
}

function sendEmail(data = {}) {

    const { emailInserted, userName, carritoUsuarioParseado, precioTexto, precioTextoConIva } = data;

    let params = {
        user_email: emailInserted,
        user_name: userName,
        purchase_summary: carritoUsuarioParseado,
        price: precioTexto,
        price_iva: precioTextoConIva
    }

    emailjs.send('service_41xoude', 'template_ywgv8ad', params)
        .then(function (response) {
            modalConMensaje(ListDeMensajesDispoiblesEnum.EMAIL_ENVIADO_CORRECTAMENTE, ListaDeTiposDeAlertaEnum.SUCCESS);
            document.querySelector('.spinner').style.display = 'none';
            document.querySelector('.modal__facturar__pago').classList.add('hidden');
            new Carrito().cleanCarrito();
            setTimeout(() => {
                location.reload();
            }, 2000);
        }, function (erro) {
            modalConMensaje(ListDeMensajesDispoiblesEnum.ERROR_ENVIO_EMAIL, ListaDeTiposDeAlertaEnum.ERROR);
            document.querySelector('.spinner').style.display = 'none';
            document.querySelector('.modal__facturar__pago').classList.add('hidden');
        });

}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#cleanHTMLElement">cleanHTMLElement</a></li><li><a href="global.html#handleCaptchaSubmit">handleCaptchaSubmit</a></li><li><a href="global.html#handleEmailSubmit">handleEmailSubmit</a></li><li><a href="global.html#handleLoginFormSubmitController">handleLoginFormSubmitController</a></li><li><a href="global.html#isValidUser">isValidUser</a></li><li><a href="global.html#modalConMensaje">modalConMensaje</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Sun Dec 29 2024 16:07:46 GMT+0000 (Coordinated Universal Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
